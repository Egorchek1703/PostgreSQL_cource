***Работа с psql***  
  
**==================> Подключение к БД <==================**  
  
psql -d БАЗА_ДАННЫХ -U ПОЛЬЗОВАТЕЛЬ -h УЗЕЛ -p ПОРТ  
\c[onnect] БАЗА_ДАННЫХ ПОЛЬЗОВАТЕЛЬ УЗЕЛ ПОРТ - создать новое подключение к базе данных (не передавая ключи для обозначения параметров подключения)  
\conninfo - получить информацию о подключении  

**==================> Справка <==================**  
  
- В командной строке:  
    psql --help  
    man psql  

- Из терминального окна psql:  
    \? - все команды psql  
    \? variables - переменные psql  
    \h[elp] - все команды SQL  
    \h конкретная_команда - синтаксис конкретной команды  
    \q - выход  
  
**==================> Переключатели <==================**  
  
\a - убрать/включить выравнивание ширины столбцов при выводе результата  
\t - включает/отключает вывод начальной строки (шапки и кол-во строк в запросе)  
\pset - устанавливает параметры выывода данных:  
    fieldsep 'символ' - устанавливает "символ" как разделитель столбцов   
\x - включает расширенный формат вывода (каждая строка (сущность) выводится как столбец)  
\gx (go + x-формат) - выполнить запрос в режиме (в ситуациях когда запрос в БД уже написан и не хочется его удалять чтобы включить x-формат)  
\\! - выполнить запрос для операционной системы, т.е. не в терминальном окне psql  
\setenv ИМЯ_ПЕРЕМЕННОЙ "Значение" - устанавливает переменную операционной системы  
\r - аналог точки с запятой ";" - означает конец текущего запроса  
\o НАЗВАНИЕ_ФАЙЛА - устанавливает файл в который будет выводиться результат запроса (также можно выводить результат запроса в файл с помощью \g) (выполнение парамерта \o без названия файла - задает вывод результата в терминальный клиент psql)  
\timing - включает/выключает вывод времени исполнения запроса  
  
Используя параметр \g, можно выполнять запросы и записывать их результат в определенный файл, а также указать необходимые для вывода результата параметры, например такие, как \x или \t  
```
SELECT * FROM pg_tables
LIMIT 5 \g (tuples_only=on format=aligned)
```
  
Чтобы выполнить скрипт из командой строки нужно использовать:  
```
    psql < название_файла
```  
или  
```  
    psql -f название_файла
```
  
Соответственно, если у нас есть файл, содержащий тот или иной скрипт, то мы можем работать с ним как из под хоста, так из терминального клиента psql. Для того чтобы выполнить команду внутри psql достаточно выполнить:  
```
    \i[nclude] название_файла
```  
Чтобы выполнить запрос из сркипта и поместить его результат сразу в файл можно использовать следующий способ:  
```
    \o result.txt  
    \i test_script.sql  
    \o
    ;
```  

\gexec (go execution) - выполнить запрос и полученный результат данного запроса тут же выполнить как отдельынй запрос. Полезно когда у нас есть таблица таблиц или что-то подобное, и нам необходимо сформировать несколько запросов. Поэтому мы сначала выполняем запрос, благодаря которому, например, с использованием функции format, получаем строки нового запроса, а после уже выполняем необходимые нам запросы из таблиц, полученный из таблицы таблиц.  
  
**==================> Переменные <==================**  
  
Мы можем внутри терминального окна psql создавать переменные с помощью:  
```
    \set НАЗВАНИЕ_ПЕРЕМЕННОЙ значение
```  
  
Также мы можем задавать внешние переменные вне терминального окна, а из под пользователя postgres:  
```
    \! export НАЗВАНИЕ_ПЕРЕМЕННОЙ "значение"
    или 
    \setenv ИМЯ_ПЕРЕМЕННОЙ "Значение"
```  
Эта переменная будет действовать в рамках текущей сессии, но после выхода из psql она исчезнет.  
С помощью команды \echo мы можем выводить определенные значения в терминал текущей сессии psql. Поэтому для того чтобы отобразить текущую переменную необходимо использовать символ двоеточик ":", т.е. выполнить:  
```
    \echo :НАЗВАНИЕ_ПЕРЕМЕННОЙ
```  
  
Чтобы удалить переменную необходимо использовать:
```
    \unset НАЗВАНИЕ_ПЕРЕМЕННОЙ
```  
  
Обычно переменные используются не для прямого хранения данных, а для того чтобы выполнить запрос и после использовать его результат, т.е. в качестве временного хранилища для результата запроса.  

Чтобы записать результат запроса, нам необходимо использовать \gset, делать это лишь для запросов с одним результирующим значением и для этого значения задать алиас, который и будет названием переменной:  
```
    SELECT now() AS current_time \gset
    \echo :current_time
```
Столбцов может быть несколько, тогда будет создано несколько перпеменных. А вот строк в запросе больше одной быть не может.  
  
Чтобы посмотреть список всех переменных, который определены в данный момент нужно выполнить:  
```
    \set
```
  
**==================> Условные операторы <==================**  
  
Условным операторам в postgresql нужно всегда подавать либо TRUE, либо FALSE. Поэтому существует специальная конструкция **:{?xпеременная}**  
В данной конструкции мы указываем значение переменной, и если данная переменная существует, то результатом будет TRUE, в противном случае - FALSE.  
Чтобы задать условное выражение нужно использовать следующий синтаксис:  
```
    \if :{?НАЗВАНИЕ_ПЕРЕМЕННОЙ}
        *команды для случая если переменная определена*
    \else
        *команды для всех остальных случаев*
    \endif
```
  
**==================> Работа с домашним каталогом и настройка/конфигурирование psql <==================**  
  
Для того чтобы получить описание таблицы (типов данных для конкретных столбцов) нужно использовать:  
```
    \d название_таблицы
```  
  
Как и большинство утилит в Unix-подобных системах, psql имеет настроечные скрипты:  
    - psqlrc - общий скрипт для всех пользователей  
    - .psqlrc - файлы для конкретного пользователя (лежат в домашнем каталоге пользователя)  
  
Данные файлы выполняют определенные команды перед запуском самой утилиты, а следовательно, с помощью их, можно задавать определенные переменные не вручную. Данный подход можно использовать для хранения в переменных частых запросов, т.к. наиболее популярные теперь будут находится в соответствующих переменных, и нам остается лишь запомнить их названия.  
Также в данных файлах можно настроить терминальную подсказку для ввода команды (символ в консоли).  
  
Теперь, благодаря тому что я добавил в файл "psqlrc" запись вида "\set sf 'SELECT * FROM '", я имею возможность написать "\echo :sf" и получить сохраненное значение при первом же запуске psql, не задавая вручную данную переменную.  
  
Чтобы изменить таким образом терминальную подсказку для ввода нужно переназначить переменную PROMPT1 и PROMPT2 на значение желаемой подсказки. [Документация](https://postgrespro.ru/docs/postgresql/16/app-psql#APP-PSQL-PROMPTING)  
  
*Чтобы сделать это для конкретного пользователя, файл ".psqlrc" необходимо положить в домашний каталог данного пользователя.*  